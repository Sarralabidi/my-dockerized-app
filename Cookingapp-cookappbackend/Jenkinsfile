pipeline {
agent any

environment {
    DOCKERHUB_CREDENTIALS = credentials('dockerhub-credentials')   // Jenkins credentials ID
    DOCKERHUB_USER = 'sarralabidi984'                                 // Your Docker Hub username
    IMAGE_NAME = 'cookapp-backend'                                      // Image name
    IMAGE_TAG = 'latest'
}

stages {

    stage('Checkout Code') {
        steps {
            echo 'üì• Cloning repository...'
            checkout scm
        }
    }

    stage('Build with Maven') {
        steps {
            dir('Cookingapp-cookappbackend/Cookingapp-cookappbackend') {
                echo 'üîß Building Spring Boot app with Maven...'
                sh 'mvn clean package -DskipTests'
            }
        }
    }

     stage('SonarQube Analysis') {
    steps {
        dir('Cookingapp-cookappbackend/Cookingapp-cookappbackend') {
            withSonarQubeEnv('MySonarQube') {
                withCredentials([string(credentialsId: '39946645-4ccc-4883-a50d-e419cf3f62a2', variable: 'SONAR_AUTH_TOKEN')]) {
                    echo 'üß† Running SonarQube analysis...'
                    sh 'mvn sonar:sonar -Dsonar.projectKey=cookapp -Dsonar.host.url=http://localhost:9000 -Dsonar.login=$SONAR_AUTH_TOKEN'
                }
            }
        }
    }
}


    stage('Build Docker Image') {
    steps {
        dir('Cookingapp-cookappbackend/Cookingapp-cookappbackend') {
            echo 'üê≥ Building Docker image...'
            sh '''
                docker build -t $DOCKERHUB_USER/$IMAGE_NAME:$IMAGE_TAG .
            '''
        }
    }
}


    stage('Push to Docker Hub') {
        steps {
            echo '‚òÅÔ∏è Pushing image to Docker Hub...'
            sh '''
                echo $DOCKERHUB_CREDENTIALS_PSW | docker login -u $DOCKERHUB_CREDENTIALS_USR --password-stdin
                docker push $DOCKERHUB_USER/$IMAGE_NAME:$IMAGE_TAG
            '''
        }
    }




stage('Deploy MySQL to Kubernetes') {
            steps {
                echo 'üê¨ Deploying MySQL to Kubernetes...'
                withCredentials([kubeconfigContent(credentialsId: 'kubeconfig', variable: 'KUBECONFIG_CONTENT')]) {
                    sh '''
                        echo "$KUBECONFIG_CONTENT" > kubeconfig-temp
                        kubectl --kubeconfig=kubeconfig-temp apply -f Cookingapp-cookappbackend/k8s/mysql-deployment.yaml
                        kubectl --kubeconfig=kubeconfig-temp apply -f Cookingapp-cookappbackend/k8s/mysql-service.yaml
                        echo "‚è≥ Waiting for MySQL to be ready..."
                        kubectl --kubeconfig=kubeconfig-temp rollout status deployment/mysql --timeout=120s
                        rm -f kubeconfig-temp
                    '''
                }
            }
        }



    

stage('Deploy to Kubernetes') {
    steps {
        echo 'üöÄ Deploying to Kubernetes...'
        withCredentials([kubeconfigContent(credentialsId: 'kubeconfig', variable: 'KUBECONFIG_CONTENT')]) {
            sh '''
                # Write content to file and use it
                echo "$KUBECONFIG_CONTENT" > kubeconfig-temp
                kubectl --kubeconfig=kubeconfig-temp apply -f Cookingapp-cookappbackend/k8s/deployment.yaml
                kubectl --kubeconfig=kubeconfig-temp apply -f Cookingapp-cookappbackend/k8s/service.yaml
                kubectl --kubeconfig=kubeconfig-temp get pods
                rm -f kubeconfig-temp
            '''
        }
    }
}




    
    
}

post {
    success {
        echo '‚úÖ Pipeline completed successfully!'
    }
    failure {
        echo '‚ùå Pipeline failed. Check logs in Jenkins.'
    }
}


}
